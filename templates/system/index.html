{% extends "base.html" %}

{% block title %}System - NixNAS{% endblock %}

{% block content %}
<header class="page-header">
    <h2>âš™ï¸ System Configuration</h2>
</header>

<div class="card">
    <h3>NixOS Configuration</h3>
    <p>NixNAS generates NixOS configuration files and applies them using <code>nixos-rebuild</code>.</p>
    
    <div class="btn-group" id="build-actions">
        <button hx-post="/api/web/system/dry-build" 
                hx-target="#build-output"
                hx-disabled-elt="#build-actions button, #rollback-btn">
            <span class="htmx-indicator spinner"></span>
            ğŸ” Dry Build
        </button>
        <button hx-post="/api/web/system/apply" 
                hx-target="#build-output"
                hx-confirm="Apply configuration and rebuild NixOS? This may take a moment."
                hx-disabled-elt="#build-actions button, #rollback-btn">
            <span class="htmx-indicator spinner"></span>
            ğŸš€ Apply Configuration
        </button>
        <button hx-post="/api/web/system/upgrade" 
                hx-target="#build-output"
                hx-confirm="Upgrade NixOS to latest channel version? Changes will apply at next reboot."
                hx-disabled-elt="#build-actions button, #rollback-btn">
            <span class="htmx-indicator spinner"></span>
            â¬†ï¸ Upgrade System
        </button>
    </div>
    
    <div id="build-output" style="margin-top: 1rem;"></div>
</div>

<div class="card">
    <h3>NixOS Generations</h3>
    <p>Switch between system configurations or rollback to a previous state.</p>
    
    <table>
        <thead>
            <tr>
                <th>Generation</th>
                <th>Date</th>
                <th>Current</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for generation in generations %}
            <tr>
                <td><strong>{{ generation.id }}</strong></td>
                <td>{{ generation.date }}</td>
                <td>
                    {% if generation.current %}
                    <span class="badge badge-success">Current</span>
                    {% endif %}
                </td>
                <td>
                    {% if !generation.current %}
                    <button class="small outline switch-btn"
                            hx-post="/api/web/system/switch/{{ generation.id }}"
                            hx-target="#build-output"
                            hx-confirm="Switch to generation {{ generation.id }}?"
                            hx-disabled-elt="#build-actions button, #rollback-btn, .switch-btn">
                        <span class="htmx-indicator spinner"></span>
                        ğŸ”„ Switch
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <button id="rollback-btn" class="outline"
            hx-post="/api/web/system/rollback"
            hx-target="#build-output"
            hx-confirm="Rollback to the previous generation?"
            hx-disabled-elt="#build-actions button, #rollback-btn">
        <span class="htmx-indicator spinner"></span>
        âª Rollback
    </button>
</div>

<div class="card">
    <h3>ğŸ’¾ Configuration Backups</h3>
    <p>NixNAS automatically backs up <code>state.json</code> before each modification. You can restore a previous configuration if needed.</p>
    
    <details>
        <summary>View Backups</summary>
        <div hx-get="/api/web/system/backups" hx-trigger="revealed" style="margin-top: 1rem;">
            Loading backups...
        </div>
    </details>
</div>

<div class="card">
    <h3>Generated Configuration Files</h3>
    <p>These files are auto-generated by NixNAS in <code>/etc/nixos/nas/</code>:</p>
    
    <details>
        <summary>ğŸ“„ default.nix</summary>
        <pre><code hx-get="/api/web/system/config/default.nix" hx-trigger="revealed">Loading...</code></pre>
    </details>
    
    <details>
        <summary>ğŸ“„ users.nix</summary>
        <pre><code hx-get="/api/web/system/config/users.nix" hx-trigger="revealed">Loading...</code></pre>
    </details>
    
    <details>
        <summary>ğŸ“„ samba.nix</summary>
        <pre><code hx-get="/api/web/system/config/samba.nix" hx-trigger="revealed">Loading...</code></pre>
    </details>
    
    <details>
        <summary>ğŸ“„ nfs.nix</summary>
        <pre><code hx-get="/api/web/system/config/nfs.nix" hx-trigger="revealed">Loading...</code></pre>
    </details>
    
    <details>
        <summary>ğŸ“„ storage.nix</summary>
        <pre><code hx-get="/api/web/system/config/storage.nix" hx-trigger="revealed">Loading...</code></pre>
    </details>
    
    <details>
        <summary>ğŸ“„ zfs.nix</summary>
        <pre><code hx-get="/api/web/system/config/zfs.nix" hx-trigger="revealed">Loading...</code></pre>
    </details>
    
    <details>
        <summary>ğŸ“„ snapshots.nix</summary>
        <pre><code hx-get="/api/web/system/config/snapshots.nix" hx-trigger="revealed">Loading...</code></pre>
    </details>
    
    <details>
        <summary>ğŸ“„ ssh.nix</summary>
        <pre><code hx-get="/api/web/system/config/ssh.nix" hx-trigger="revealed">Loading...</code></pre>
    </details>
    
    <details>
        <summary>ğŸ“„ rsyncd.nix</summary>
        <pre><code hx-get="/api/web/system/config/rsyncd.nix" hx-trigger="revealed">Loading...</code></pre>
    </details>
    
    <details>
        <summary>ğŸ“„ smartd.nix</summary>
        <pre><code hx-get="/api/web/system/config/smartd.nix" hx-trigger="revealed">Loading...</code></pre>
    </details>
</div>
{% endblock %}
