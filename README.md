# NixNAS

Web-based NAS management daemon for NixOS.

## Features

- **Storage Management**
  - ZFS pools and datasets
  - Btrfs filesystems and subvolumes
  - mdadm software RAID
  - ext4, XFS filesystem support
  - S.M.A.R.T. disk monitoring

- **Network Shares**
  - SMB/CIFS (Samba)
  - NFS exports

- **NixOS Integration**
  - Generates NixOS configuration files
  - Manages services via `nixos-rebuild`
  - Supports rollback to previous generations

## Installation

### Using Flakes

Add to your `flake.nix`:

```nix
{
  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    nixnas.url = "github:liberodark/nixnas";
  };

  outputs = { self, nixpkgs, nixnas }: {
    nixosConfigurations.mynas = nixpkgs.lib.nixosSystem {
      system = "x86_64-linux";
      modules = [
        ./configuration.nix
        nixnas.nixosModules.default
        {
          services.nixnas = {
            enable = true;
            port = 8080;
            openFirewall = true;
          };
        }
      ];
    };
  };
}
```

### Configuration

After enabling NixNAS, add this import to your `/etc/nixos/configuration.nix`:

```nix
{
  imports = [
    ./hardware-configuration.nix
    ./nas  # Generated by NixNAS
  ];
}
```

## API

NixNAS exposes a JSON-RPC API on the configured port.

### Authentication

```bash
# Login
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "your-password"}'

# Response: {"token": "eyJ..."}
```

### RPC Calls

```bash
# List disks
curl -X POST http://localhost:8080/api/rpc \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"service": "storage", "method": "list_disks", "params": {}}'

# Create ZFS pool
curl -X POST http://localhost:8080/api/rpc \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "service": "zfs",
    "method": "create_pool",
    "params": {
      "name": "tank",
      "level": "mirror",
      "devices": ["/dev/sdb", "/dev/sdc"]
    }
  }'

# Create SMB share
curl -X POST http://localhost:8080/api/rpc \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "service": "smb",
    "method": "create_share",
    "params": {
      "name": "media",
      "path": "/tank/media",
      "guest_ok": true,
      "read_only": false
    }
  }'

# Apply configuration
curl -X POST http://localhost:8080/api/rpc \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"service": "system", "method": "apply", "params": {}}'
```

## Available Services

### storage
- `list_disks` - List physical disks
- `list_block_devices` - List all block devices
- `get_device` - Get device info
- `list_mounts` - List mount points
- `mount` / `umount` - Mount/unmount filesystems
- `mkfs` - Create filesystem
- `wipe` - Wipe device signatures

### zfs
- `list_pools` - List ZFS pools
- `pool_status` - Get pool status
- `create_pool` / `destroy_pool` - Manage pools
- `list_datasets` - List datasets
- `create_dataset` / `destroy_dataset` - Manage datasets
- `list_snapshots` - List snapshots
- `create_snapshot` / `destroy_snapshot` - Manage snapshots
- `scrub_start` - Start pool scrub

### btrfs
- `list_filesystems` - List Btrfs filesystems
- `list_subvolumes` - List subvolumes
- `create_subvolume` / `delete_subvolume` - Manage subvolumes
- `create_snapshot` - Create snapshot
- `scrub_start` / `balance_start` - Maintenance

### mdadm
- `list_arrays` - List RAID arrays
- `array_detail` - Get array details
- `create_array` / `stop_array` - Manage arrays
- `add_device` / `remove_device` / `fail_device` - Manage devices

### smart
- `get_info` - Get S.M.A.R.T. info
- `health_check` - Quick health check
- `start_test` - Start self-test
- `get_test_results` - Get test results

### smb
- `get_config` - Get SMB configuration
- `set_enabled` - Enable/disable SMB
- `list_shares` - List shares
- `create_share` / `update_share` / `delete_share` - Manage shares
- `list_connections` - List active connections

### nfs
- `get_config` - Get NFS configuration
- `set_enabled` - Enable/disable NFS
- `list_exports` - List exports
- `create_export` / `delete_export` - Manage exports
- `list_clients` - List connected clients

### system
- `apply` - Apply configuration (nixos-rebuild switch)
- `dry_build` - Test configuration
- `list_generations` - List NixOS generations
- `rollback` - Rollback to previous generation
- `switch_generation` - Switch to specific generation

## Development

```bash
# Enter development shell
nix-shell

# Build
cargo build

# Run
cargo run

# Test
cargo test
```

## Environment Variables

- `NIXNAS_STATE_PATH` - Path to state.json (default: `/var/lib/nixnas/state.json`)
- `NIXNAS_NIX_OUTPUT_DIR` - NixOS config output directory (default: `/etc/nixos`)
- `NIXNAS_LISTEN_ADDR` - Listen address (default: `0.0.0.0:8080`)
- `RUST_LOG` - Log level (default: `nixnas_daemon=info`)
